# Docker网络原理

## 使用到的Linux技术

- 网络命名空间
- veth设备对
- 网桥bridge
- iptables
- 路由

### Linux抽象网络设备简介

和磁盘设备类似，**Linux 用户想要使用网络功能，不能通过直接操作硬件完成，而需要直接或间接的操作一个 Linux 为我们抽象出来的设备，既通用的 Linux 网络设备来完成**。**一个常见的情况是，系统里装有一个硬件网卡，Linux 会在系统里为其生成一个网络设备实例**，如 eth0，用户需要对 eth0 发出命令以配置或使用它了。更多的硬件会带来更多的设备实例，虚拟的硬件也会带来更多的设备实例。随着网络技术，虚拟化技术的发展，更多的高级网络设备被加入了到了 Linux 中，使得情况变得更加复杂。

### 网络命名空间

#### 作用

Linux中为了支持网络协议栈的多个实例，引入了网络命名空间，可以简单理解成相互不干扰、互相隔离的平行网络空间。通过创建不同的网络命名空间，就可以在一台机器上模拟多个不同的网络环境。每个网络命名空间中，都可以有自己独立的路由表，及独立的iptables来提供包转发、NAT等功能。Docker正是利用了网络空间的这个特性，**实现容器之间的网络隔离（端口号相互不会冲突）**。

>NAT 技术：
>
>**内网主机发送的数据包的源地址在 Internet 上是不合发的，是不能被识别的**，所以，需要在路由器上**通过 NAT 技术，将源地址转换为路由器所对应的合法的 Internet 地址**。比如，我们有路由器，且该路由器的 IP 地址是 Internet 的合法地址 172.168.23.5，而内网主机的 IP 地址是 192.168.32.5，那么此时，如果 192.168.32.5 发送一个数据包到 Internet 上的某个主机 10.158.8.8，因为数据包源地址 192.168.32.5 不是 Internet 上的合法地址，所以，10.158.8.8 在收到数据包以后，无法进行回执；所以，当内网数据包经过路由器的时候，路由器需要对源地址进行转换，将 192.168.32.5 的地址转换为 172.168.32.5，所以，当 10.158.8.8 收到数据包以后，才能进行有效的回执。-> 这就是 NAT；

### VETH设备对

#### 作用

VETH 设备出现较早，它的作用是反转通讯数据的方向，需要发送的数据会被转换成需要收到的数据重新送入内核网络层进行处理，从而间接的完成数据的注入。

>网络命名空间代表的是一个独立的协议栈，相互之间是隔离的，彼此无法直接通信，那如果想在不同的命名空间之间通信，就要用到veth设备对了。它的作用就像是一个管道，一端连着自己的命名空间协议栈，另一端连着另一个命名空间的peer，当veth设备在一端发送数据时，会直接将数据发送给自己的peer，并触发peer接收数据，然后peer把收到的数据再提交到自己的网络协议栈进行处理，从而实现不同协议栈之间的数据传输

VETH 设备总是成对出现，送到一端请求发送的数据总是从另一端以请求接受的形式出现。该设备不能被用户程序直接操作，但使用起来比较简单。创建并配置正确后，向其一端输入数据，VETH 会改变数据的方向并将其送入内核网络核心，完成数据的注入。在另一端能读到此数据。

### 网桥Bridge

Bridge（桥）是 Linux 上用来做 TCP/IP 二层协议交换的设备，与现实世界中的交换机功能相似。Bridge 设备实例可以和 Linux 上其他网络设备实例连接，既 attach 一个从设备，类似于在现实世界中的交换机和一个用户终端之间连接一根网线。当有数据到达时，Bridge 会根据报文中的 MAC 信息进行广播、转发、丢弃处理。

## Docker的CNM网络模型

```java
=================================================================================
||    A Docker Container     ||   A Docker Container    ||  A Docker Container ||            
||                           ||                         ||                     ||
||                           ||                         ||                     ||
||                           ||                         ||                     || 
||    -------------------    ||   --------------------- ||   -------------     || 
||    |  network sanbox  |   ||   | network sanbox     |||   | network   |     ||
||    |                  |   ||   |                    |||   | sanbox    |     ||
||    |   ---------------|   ||   |--------------------|||   |-----------|     ||
||    |   |              |   ||   |                    |||   |           |     ||
||    |   |   endpoint   |   ||   | endpoint1 endpoint2|||   | endpoint  |     ||
=================||=====================||=========||==============||============
                 ||                     ||         ||              ||
                 ||                     ||         ||              ||
                 ||                     ||         ||              ||
                 ||-------Network-------||         ||----Network---||
```

>CNM模型有三个组件：
>
>- Sanbox: 每个沙盒包含一个容器网络栈的配置，包括：端口、路由表和DNS设置等
>- Endpoint：通过Endpoint，沙盒可以被加入到一个Network里
>- Network：一组能相互通信的 Endpoints。
>
>CNM模型在Linux上的参考实现技术，比如：沙盒的实现可以是一个[Linux Network Namespace](https://en.wikipedia.org/wiki/Linux_namespaces#Network_.28net.29)；Endpoint可以是一对[VETH](https://openvz.org/Virtual_Ethernet_device)；Network则可以用[Linux Bridge](https://wiki.linuxfoundation.org/networking/bridge)或[Vxlan](https://en.wikipedia.org/wiki/Virtual_Extensible_LAN)实现。



## 参考

- [Linux 上的基础网络设备详解](https://cloud.tencent.com/developer/article/1115583)
- [理解Docker容器网络之Linux Network Namespace](https://tonybai.com/2017/01/11/understanding-linux-network-namespace-for-docker-network/)
- [计算机网络路由器](https://www.shangyang.me/2017/01/02/network-router/#NAT)

